<div class="ecommerce-container">

  <!-- ===================================
       TOP NAVIGATION BAR
       =================================== -->
  <nav class="ecommerce-nav">
    <div class="nav-container">
      <!-- Left: Logo & Tabs -->
      <div class="nav-left">
        <div class="nav-logo" (click)="navigateTo('catalog')">
          <span class="material-icons">storefront</span>
          <span class="logo-text">Semprechiaro Store</span>
        </div>
        
        <!-- Desktop Navigation Tabs -->
        <div class="nav-tabs" *ngIf="!isMobile">
          <button class="nav-tab" 
                  [class.active]="currentView === 'catalog' || currentView === 'product-detail'"
                  (click)="navigateTo('catalog')">
            <span class="material-icons">store</span>
            <span>Catalogo</span>
          </button>
          <button class="nav-tab" 
                  [class.active]="currentView === 'orders' || currentView === 'order-detail'"
                  (click)="goToOrders()">
            <span class="material-icons">receipt_long</span>
            <span>I Miei Ordini</span>
          </button>
        </div>
      </div>

      <!-- Center: Search Bar -->
      <div class="nav-center">
        <div class="search-container">
          <span class="material-icons search-icon">search</span>
          <input type="text" 
                 #searchInput
                 class="search-input"
                 placeholder="Cerca prodotti..."
                 [value]="searchQuery"
                 (input)="onSearchInput($event)"
                 (keyup.enter)="loadArticles(true)">
          <button class="search-clear" *ngIf="searchQuery" (click)="clearSearch()">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>

      <!-- Right: Balance & Cart -->
      <div class="nav-right">
        <!-- PV Balance Display -->
        <div class="pv-balance" *ngIf="userBalance">
          <span class="material-icons">account_balance_wallet</span>
          <div class="pv-info">
            <span class="pv-label">Disponibili</span>
            <span class="pv-value">{{ formatPv(userBalance.pv_disponibili) }}</span>
          </div>
        </div>

        <!-- Cart Button -->
        <button class="cart-button" (click)="toggleCart()">
          <span class="material-icons">shopping_cart</span>
          <span class="cart-badge" *ngIf="cartItemsCount > 0">
            {{ cartItemsCount > 99 ? '99+' : cartItemsCount }}
          </span>
        </button>
      </div>
    </div>
  </nav>

  <!-- ===================================
       MAIN CONTENT AREA
       =================================== -->
  <main class="ecommerce-main">

    <!-- ===================================
         CATALOG VIEW
         =================================== -->
    <div *ngIf="currentView === 'catalog'" [@pageTransition] class="catalog-view">
      
      <!-- Hero Carousel -->
      <section class="hero-carousel">
        <div class="carousel-wrapper">
          <div class="carousel-slides" 
               [style.transform]="'translateX(-' + (currentSlideIndex * 100) + '%)'">
            <div class="carousel-slide" 
                 *ngFor="let slide of carouselSlides; let i = index"
                 [style.background]="slide.gradient">
              <div class="slide-content">
                <div class="slide-text">
                  <span class="slide-badge">{{ slide.badge }}</span>
                  <h1>{{ slide.title }}</h1>
                  <p>{{ slide.description }}</p>
                  <button class="slide-cta" 
                          [class.disabled]="slide.ctaDisabled"
                          [disabled]="slide.ctaDisabled"
                          (click)="onCarouselCtaClick(slide.ctaAction)">
                    <span>{{ slide.ctaText }}</span>
                    <span class="material-icons">{{ slide.ctaDisabled ? 'schedule' : 'arrow_forward' }}</span>
                  </button>
                </div>
                <div class="slide-image">
                  <img [src]="slide.imageUrl" [alt]="slide.title">
                </div>
              </div>
            </div>
          </div>

          <!-- Carousel Controls -->
          <button class="carousel-arrow prev" (click)="prevSlide()">
            <span class="material-icons">chevron_left</span>
          </button>
          <button class="carousel-arrow next" (click)="nextSlide()">
            <span class="material-icons">chevron_right</span>
          </button>

          <!-- Carousel Dots -->
          <div class="carousel-dots">
            <button *ngFor="let slide of carouselSlides; let i = index"
                    class="carousel-dot"
                    [class.active]="i === currentSlideIndex"
                    (click)="goToSlide(i)">
            </button>
          </div>
        </div>
      </section>

      <!-- Filters Section -->
      <section class="filters-section" #catalogSection>
        <div class="filters-header">
          <h2>
            <span class="material-icons">card_giftcard</span>
            Prodotti Disponibili
          </h2>
          <div class="filters-actions">
            <button class="filter-toggle-btn" (click)="toggleFilters()">
              <span class="material-icons">tune</span>
              <span>Filtri</span>
              <span class="filter-badge" *ngIf="hasActiveFilters()"></span>
            </button>
            <select class="sort-select" [value]="sortOption" (change)="onSortChange($any($event.target).value)">
              <option value="default">Ordina per</option>
              <option value="price_asc">Prezzo: Basso → Alto</option>
              <option value="price_desc">Prezzo: Alto → Basso</option>
              <option value="name_asc">Nome: A → Z</option>
              <option value="name_desc">Nome: Z → A</option>
              <option value="newest">Più Recenti</option>
            </select>
          </div>
        </div>

        <!-- Expanded Filters -->
        <div class="filters-expanded" *ngIf="showFilters" [@fadeIn]>
          <div class="filter-group">
            <label>Store</label>
            <select (change)="filterByStore($any($event.target).value || null)">
              <option value="">Tutti gli Store</option>
              <option *ngFor="let store of stores" [value]="store.slug">
                {{ store.store_name }} ({{ store.articles_count }})
              </option>
            </select>
          </div>
          <div class="filter-group">
            <label>Categoria</label>
            <select (change)="filterByCategory($any($event.target).value ? +$any($event.target).value : null)">
              <option value="">Tutte le Categorie</option>
              <option *ngFor="let cat of categories" [value]="cat.id">
                {{ cat.category_name }} ({{ cat.articles_count }})
              </option>
            </select>
          </div>
          <div class="filter-group">
            <label>Prezzo Min (PV)</label>
            <input type="number" 
                   [value]="priceRange.min" 
                   (change)="priceRange.min = $any($event.target).value ? +$any($event.target).value : null; loadArticles(true)"
                   placeholder="0">
          </div>
          <div class="filter-group">
            <label>Prezzo Max (PV)</label>
            <input type="number" 
                   [value]="priceRange.max" 
                   (change)="priceRange.max = $any($event.target).value ? +$any($event.target).value : null; loadArticles(true)"
                   placeholder="∞">
          </div>
          <button class="clear-filters-btn" *ngIf="hasActiveFilters()" (click)="clearFilters()">
            <span class="material-icons">clear_all</span>
            Rimuovi Filtri
          </button>
        </div>

        <!-- Active Filters Tags -->
        <div class="active-filters" *ngIf="hasActiveFilters()">
          <span class="filter-tag" *ngIf="selectedStore">
            {{ selectedStore.store_name }}
            <button (click)="filterByStore(null)">
              <span class="material-icons">close</span>
            </button>
          </span>
          <span class="filter-tag" *ngIf="selectedCategory">
            {{ selectedCategory.category_name }}
            <button (click)="filterByCategory(null)">
              <span class="material-icons">close</span>
            </button>
          </span>
          <span class="filter-tag" *ngIf="searchQuery">
            "{{ searchQuery }}"
            <button (click)="clearSearch()">
              <span class="material-icons">close</span>
            </button>
          </span>
        </div>
      </section>

      <!-- Products Grid -->
      <section class="products-section">
        <!-- Loading State -->
        <div class="loading-container" *ngIf="isLoading">
          <div class="spinner"></div>
          <p>Caricamento prodotti...</p>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="!isLoading && articles.length === 0">
          <span class="material-icons">inventory_2</span>
          <h3>Nessun prodotto trovato</h3>
          <p>Prova a modificare i filtri o la ricerca</p>
          <button class="btn-primary" (click)="clearFilters()">
            <span class="material-icons">refresh</span>
            Mostra Tutti i Prodotti
          </button>
        </div>

        <!-- Products Grid -->
        <div class="products-grid" *ngIf="!isLoading && articles.length > 0">
          <div class="product-card" 
               *ngFor="let article of articles; trackBy: trackByArticleId"
               (click)="openProductDetail(article)">
            
            <!-- Product Badges -->
            <div class="product-badges">
              <span class="badge digital" *ngIf="article.is_digital">Digitale</span>
              <span class="badge featured" *ngIf="article.is_featured">
                <span class="material-icons">star</span>
              </span>
            </div>

            <!-- Product Image -->
            <div class="product-image">
              <img [src]="article.thumbnail_url || 'https://via.placeholder.com/200x200?text=No+Image'" 
                   [alt]="article.article_name"
                   loading="lazy">
            </div>

            <!-- Product Info -->
            <div class="product-info">
              <span class="product-category">{{ article.category_name }}</span>
              <h3 class="product-title">{{ article.article_name }}</h3>
              <p class="product-description">{{ article.description }}</p>
              
              <div class="product-footer">
                <div class="product-price">
                  <span class="price-label">Prezzo</span>
                  <span class="price-value">{{ formatPv(article.pv_price) }}</span>
                </div>
                <button class="btn-add-cart" 
                        (click)="$event.stopPropagation(); addToCart(article)"
                        [disabled]="!canAffordProduct(article)">
                  <span class="material-icons">add_shopping_cart</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Load More Button -->
        <div class="load-more-container" *ngIf="hasMoreArticles()">
          <button class="btn-load-more" 
                  [disabled]="isLoadingMore"
                  (click)="loadMoreArticles()">
            <span class="material-icons" *ngIf="!isLoadingMore">expand_more</span>
            <div class="spinner-small" *ngIf="isLoadingMore"></div>
            <span>{{ isLoadingMore ? 'Caricamento...' : 'Carica Altri' }}</span>
          </button>
        </div>
      </section>
    </div>

    <!-- ===================================
         PRODUCT DETAIL VIEW
         =================================== -->
    <div *ngIf="currentView === 'product-detail' && selectedArticle" [@pageTransition] class="product-detail-view">
      
      <!-- Back Button -->
      <div class="back-nav">
        <button class="back-btn" (click)="closeProductDetail()">
          <span class="material-icons">arrow_back</span>
          Torna al Catalogo
        </button>
      </div>

      <div class="product-detail-grid">
        <!-- Product Gallery -->
        <div class="product-gallery">
          <div class="gallery-badges">
            <span class="badge digital" *ngIf="selectedArticle.is_digital">Digitale</span>
            <span class="badge featured" *ngIf="selectedArticle.is_featured">Best Seller</span>
          </div>
          <div class="main-image">
            <img [src]="selectedArticle.thumbnail_url || 'https://via.placeholder.com/400x400?text=No+Image'" 
                 [alt]="selectedArticle.article_name">
          </div>
        </div>

        <!-- Product Details -->
        <div class="product-details">
          <span class="detail-category">{{ selectedArticle.category?.name || selectedArticle.category_name }}</span>
          <h1 class="detail-title">{{ selectedArticle.article_name }}</h1>
          
          <!-- Rating (placeholder) -->
          <div class="product-rating">
            <div class="stars">
              <span class="material-icons" *ngFor="let star of [1,2,3,4,5]">star</span>
            </div>
            <span class="rating-text">5.0 (127 recensioni)</span>
          </div>

          <!-- Price Section -->
          <div class="price-section">
            <div class="price-main">
              <span class="price-label">Prezzo</span>
              <span class="price-value">{{ formatPv(selectedArticle.pv_price) }}</span>
            </div>
            <div class="price-equivalent" *ngIf="selectedArticle.euro_price">
              <span>Valore: {{ formatEuro(selectedArticle.euro_price) }}</span>
            </div>
          </div>

          <!-- Stock Status -->
          <div class="stock-status" *ngIf="selectedArticle.stock">
            <span class="material-icons" [class.in-stock]="selectedArticle.stock.in_stock">
              {{ selectedArticle.stock.in_stock ? 'check_circle' : 'error' }}
            </span>
            <span>{{ selectedArticle.stock.in_stock ? 'Disponibile' : 'Non disponibile' }}</span>
          </div>

          <!-- Description -->
          <div class="product-description-full">
            <h3>Descrizione</h3>
            <p>{{ selectedArticle.description }}</p>
          </div>

          <!-- Features -->
          <div class="product-features" *ngIf="selectedArticle.is_digital">
            <div class="feature-item">
              <span class="material-icons">flash_on</span>
              <span>Consegna Immediata</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">email</span>
              <span>Codice via Email</span>
            </div>
            <div class="feature-item">
              <span class="material-icons">all_inclusive</span>
              <span>Nessuna Scadenza</span>
            </div>
          </div>

          <!-- Quantity & Add to Cart -->
          <div class="add-to-cart-section">
            <div class="quantity-selector">
              <button (click)="decrementQuantity()" [disabled]="selectedQuantity <= 1">
                <span class="material-icons">remove</span>
              </button>
              <span class="quantity-value">{{ selectedQuantity }}</span>
              <button (click)="incrementQuantity()" [disabled]="selectedQuantity >= maxQuantity">
                <span class="material-icons">add</span>
              </button>
            </div>

            <button class="btn-add-to-cart-main" 
                    [disabled]="!canAffordProduct(selectedArticle)"
                    (click)="addToCartFromDetail()">
              <span class="material-icons">add_shopping_cart</span>
              <span>Aggiungi al Carrello</span>
              <span class="btn-price">{{ formatPv(selectedArticle.pv_price * selectedQuantity) }}</span>
            </button>
          </div>

          <!-- Insufficient PV Warning -->
          <div class="pv-warning" *ngIf="!canAffordProduct(selectedArticle)">
            <span class="material-icons">warning</span>
            <span>PV insufficienti. Ti servono {{ formatPv((selectedArticle.pv_price * selectedQuantity) - (userBalance?.pv_disponibili || 0)) }} in più.</span>
          </div>

          <!-- User Balance Info -->
          <div class="balance-info" *ngIf="userBalance">
            <div class="balance-item">
              <span class="label">I tuoi PV disponibili:</span>
              <span class="value">{{ formatPv(userBalance.pv_disponibili) }}</span>
            </div>
            <div class="balance-item" *ngIf="userBalance.pv_bloccati > 0">
              <span class="label">PV nel carrello:</span>
              <span class="value blocked">{{ formatPv(userBalance.pv_bloccati) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================================
         CHECKOUT VIEW
         =================================== -->
    <div *ngIf="currentView === 'checkout'" [@pageTransition] class="checkout-view">
      
      <!-- Back Button -->
      <div class="back-nav">
        <button class="back-btn" (click)="cancelCheckout()">
          <span class="material-icons">arrow_back</span>
          Torna al Catalogo
        </button>
      </div>

      <div class="checkout-container">
        <!-- Checkout Main -->
        <div class="checkout-main">
          <h1>
            <span class="material-icons">shopping_bag</span>
            Riepilogo Ordine
          </h1>

          <!-- Order Items -->
          <div class="order-items">
            <div class="order-item" *ngFor="let item of cartItems; trackBy: trackByCartItemId">
              <div class="order-item-image">
                <img [src]="item.thumbnail_url || 'https://via.placeholder.com/80x80?text=No+Image'" 
                     [alt]="item.article_name">
              </div>
              <div class="order-item-details">
                <h4>{{ item.article_name }}</h4>
                <p>SKU: {{ item.article_sku }}</p>
                <span class="item-qty">Qtà: {{ item.quantity }}</span>
              </div>
              <div class="order-item-price">
                {{ formatPv(item.pv_total) }}
              </div>
            </div>
          </div>

          <!-- Customer Message -->
          <div class="customer-message-section">
            <h3>Note per l'ordine (opzionale)</h3>
            <textarea [(ngModel)]="customerMessage" 
                      placeholder="Aggiungi eventuali note o richieste speciali..."
                      rows="3"
                      maxlength="500"></textarea>
            <span class="char-count">{{ customerMessage.length }}/500</span>
          </div>

          <!-- Payment Method -->
          <div class="payment-section">
            <h3>Metodo di Pagamento</h3>
            <div class="payment-method selected">
              <div class="payment-icon">
                <span class="material-icons">account_balance_wallet</span>
              </div>
              <div class="payment-info">
                <h4>Punti Valore (PV)</h4>
                <p>Paga con i tuoi Punti Valore accumulati</p>
              </div>
              <span class="material-icons check">check_circle</span>
            </div>
            
            <!-- Future Payment Methods (disabled) -->
            <div class="payment-method disabled">
              <div class="payment-icon">
                <span class="material-icons">credit_card</span>
              </div>
              <div class="payment-info">
                <h4>Carta di Credito</h4>
                <p>Prossimamente</p>
              </div>
              <span class="coming-soon-badge">Coming Soon</span>
            </div>
          </div>
        </div>

        <!-- Checkout Sidebar -->
        <div class="checkout-sidebar">
          <div class="order-summary">
            <h3>Riepilogo</h3>
            
            <div class="summary-row">
              <span>Articoli ({{ cartItemsCount }})</span>
              <span>{{ formatPv(cartTotalPv) }}</span>
            </div>
            
            <div class="summary-divider"></div>
            
            <div class="summary-row total">
              <span>Totale Ordine</span>
              <span class="total-value">{{ formatPv(cartTotalPv) }}</span>
            </div>

            <div class="summary-divider"></div>

            <div class="pv-balance-summary">
              <div class="balance-row">
                <span>PV Disponibili</span>
                <span>{{ formatPv(userBalance?.pv_disponibili || 0) }}</span>
              </div>
              <div class="balance-row">
                <span>Costo Ordine</span>
                <span class="debit">-{{ formatPv(cartTotalPv) }}</span>
              </div>
              <div class="balance-row remaining" [class.insufficient]="!canAffordCart()">
                <span>Rimanenti</span>
                <span>{{ formatPv(getRemainingPvAfterCheckout()) }}</span>
              </div>
            </div>

            <!-- Place Order Button -->
            <button class="btn-place-order" 
                    [disabled]="!canAffordCart() || isProcessingCheckout || cartItems.length === 0"
                    (click)="placeOrder()">
              <span class="material-icons" *ngIf="!isProcessingCheckout">lock</span>
              <div class="spinner-small" *ngIf="isProcessingCheckout"></div>
              <span>{{ isProcessingCheckout ? 'Elaborazione...' : 'Conferma Ordine' }}</span>
            </button>

            <!-- Insufficient PV Warning -->
            <div class="checkout-warning" *ngIf="!canAffordCart()">
              <span class="material-icons">warning</span>
              <span>PV insufficienti per completare l'ordine</span>
            </div>

            <!-- Security Note -->
            <div class="security-note">
              <span class="material-icons">verified_user</span>
              <span>I tuoi PV sono al sicuro. Verranno addebitati solo dopo la conferma.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================================
         ORDER SUCCESS VIEW
         =================================== -->
    <div *ngIf="currentView === 'order-success'" [@pageTransition] class="success-view">
      <div class="success-card" [@scaleIn]>
        <div class="success-icon">
          <span class="material-icons">check_circle</span>
        </div>
        
        <h1>Ordine Completato!</h1>
        <p class="success-message">Il tuo ordine è stato ricevuto e sarà elaborato a breve.</p>

        <div class="order-number-box">
          <label>Numero Ordine</label>
          <span class="order-number">{{ lastOrderNumber }}</span>
        </div>

        <div class="success-details">
          <h3>Dettagli Ordine</h3>
          <div class="detail-row">
            <span class="label">Data</span>
            <span class="value">{{ lastOrderDate }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Totale</span>
            <span class="value">{{ formatPv(lastOrderTotal) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Stato</span>
            <span class="value status-pending">In Attesa</span>
          </div>
        </div>

        <div class="success-info">
          <span class="material-icons">info</span>
          <p>Riceverai una notifica quando il tuo ordine sarà elaborato. I codici dei buoni ti saranno inviati via email.</p>
        </div>

        <div class="success-actions">
          <button class="btn-primary" (click)="goToOrders()">
            <span class="material-icons">receipt_long</span>
            Vai ai Miei Ordini
          </button>
          <button class="btn-secondary" (click)="continueShopping()">
            <span class="material-icons">storefront</span>
            Continua lo Shopping
          </button>
        </div>
      </div>
    </div>

    <!-- ===================================
         ORDERS LIST VIEW
         =================================== -->
    <div *ngIf="currentView === 'orders'" [@pageTransition] class="orders-view">
      
      <!-- Back Button -->
      <div class="back-nav">
        <button class="back-btn" (click)="navigateTo('catalog')">
          <span class="material-icons">arrow_back</span>
          Torna al Catalogo
        </button>
      </div>

      <div class="orders-header">
        <h1>
          <span class="material-icons">receipt_long</span>
          I Miei Ordini
        </h1>
        
        <div class="orders-filters">
          <button class="filter-btn" 
                  [class.active]="ordersFilter === ''"
                  (click)="filterOrders('')">
            Tutti
          </button>
          <button class="filter-btn" 
                  [class.active]="ordersFilter === 'in_attesa'"
                  (click)="filterOrders('in_attesa')">
            In Attesa
          </button>
          <button class="filter-btn" 
                  [class.active]="ordersFilter === 'in_lavorazione'"
                  (click)="filterOrders('in_lavorazione')">
            In Elaborazione
          </button>
          <button class="filter-btn" 
                  [class.active]="ordersFilter === 'completato'"
                  (click)="filterOrders('completato')">
            Completati
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-container" *ngIf="isLoadingOrders">
        <div class="spinner"></div>
        <p>Caricamento ordini...</p>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!isLoadingOrders && orders.length === 0">
        <span class="material-icons">receipt_long</span>
        <h3>Nessun Ordine</h3>
        <p>Non hai ancora effettuato ordini</p>
        <button class="btn-primary" (click)="navigateTo('catalog')">
          <span class="material-icons">storefront</span>
          Vai al Catalogo
        </button>
      </div>

      <!-- Orders List -->
      <div class="orders-list" *ngIf="!isLoadingOrders && orders.length > 0">
        <div class="order-card" *ngFor="let order of orders; trackBy: trackByOrderId">
          <div class="order-card-header">
            <div class="order-info">
              <div class="info-item">
                <span class="label">Ordine</span>
                <span class="value">{{ order.order_number }}</span>
              </div>
              <div class="info-item">
                <span class="label">Data</span>
                <span class="value">{{ order.created_at }}</span>
              </div>
              <div class="info-item">
                <span class="label">Articoli</span>
                <span class="value">{{ order.items_count }}</span>
              </div>
            </div>
            <span class="order-status" [ngClass]="getStatusClass(order.status)">
              {{ order.status_label }}
            </span>
          </div>
          
          <div class="order-card-body">
            <!-- Progress Bar for fulfillment -->
            <div class="fulfillment-progress" *ngIf="order.status !== 'annullato'">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="order.fulfillment_progress"></div>
              </div>
              <span class="progress-text">{{ order.fulfillment_progress }}% completato</span>
            </div>

            <div class="order-card-footer">
              <div class="order-total">{{ order.formatted_total_pv }}</div>
              <button class="btn-view-order" (click)="viewOrderDetail(order)">
                <span class="material-icons">visibility</span>
                Dettagli
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================================
         ORDER DETAIL VIEW
         =================================== -->
    <div *ngIf="currentView === 'order-detail' && selectedOrder" [@pageTransition] class="order-detail-view">
      
      <!-- Back Button -->
      <div class="back-nav">
        <button class="back-btn" (click)="backToOrders()">
          <span class="material-icons">arrow_back</span>
          Torna agli Ordini
        </button>
      </div>

      <div class="order-detail-container">
        <!-- Order Header -->
        <div class="order-detail-header">
          <div class="order-main-info">
            <h1>Ordine {{ selectedOrder.order_number }}</h1>
            <span class="order-status large" [ngClass]="getStatusClass(selectedOrder.status)">
              {{ selectedOrder.status_label }}
            </span>
          </div>
          
          <div class="order-meta">
            <div class="meta-item">
              <span class="material-icons">calendar_today</span>
              <span>{{ selectedOrder.created_at }}</span>
            </div>
            <div class="meta-item" *ngIf="selectedOrder.processed_at">
              <span class="material-icons">check_circle</span>
              <span>Completato: {{ selectedOrder.processed_at }}</span>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="order-detail-items">
          <h2>Articoli Ordinati</h2>
          
          <div class="detail-item" *ngFor="let item of selectedOrderItems">
            <div class="item-info">
              <h4>{{ item.article_name }}</h4>
              <p>SKU: {{ item.article_sku }}</p>
              <span class="item-status" [ngClass]="getItemStatusClass(item.status)">
                {{ item.status_label }}
              </span>
            </div>
            
            <div class="item-quantity">
              x{{ item.quantity }}
            </div>
            
            <div class="item-price">
              {{ item.formatted_total_price }}
            </div>

            <!-- Redemption Code (if fulfilled) -->
            <div class="redemption-code" *ngIf="item.redemption_code">
              <span class="code-label">Codice Riscatto:</span>
              <code class="code-value">{{ item.redemption_code }}</code>
              <button class="copy-btn" (click)="copyToClipboard(item.redemption_code)">
                <span class="material-icons">content_copy</span>
              </button>
            </div>

            <!-- Customer Note -->
            <div class="customer-note" *ngIf="item.customer_note">
              <span class="material-icons">info</span>
              <span>{{ item.customer_note }}</span>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="order-detail-summary">
          <div class="summary-box">
            <h3>Riepilogo</h3>
            <div class="summary-row">
              <span>Totale Articoli</span>
              <span>{{ selectedOrder.items_count }}</span>
            </div>
            <div class="summary-row total">
              <span>Totale Ordine</span>
              <span>{{ selectedOrder.formatted_total_pv }}</span>
            </div>
          </div>
        </div>

        <!-- Order Customer Message -->
        <div class="order-message" *ngIf="selectedOrder.customer_message">
          <h3>
            <span class="material-icons">message</span>
            Note Ordine
          </h3>
          <p>{{ selectedOrder.customer_message }}</p>
        </div>
      </div>
    </div>

  </main>

  <!-- ===================================
       CART SIDEBAR
       =================================== -->
  <div class="cart-overlay" 
       [class.active]="isCartOpen" 
       (click)="closeCart()"></div>
  
  <aside class="cart-sidebar" [@cartSlide]="isCartOpen ? 'open' : 'closed'">
    <div class="cart-header">
      <h2>
        <span class="material-icons">shopping_cart</span>
        Carrello
      </h2>
      <button class="close-cart-btn" (click)="closeCart()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <!-- Empty Cart -->
    <div class="cart-empty" *ngIf="cartItems.length === 0">
      <span class="material-icons">shopping_cart</span>
      <h3>Il carrello è vuoto</h3>
      <p>Aggiungi prodotti per iniziare</p>
      <button class="btn-primary" (click)="closeCart(); navigateTo('catalog')">
        <span class="material-icons">storefront</span>
        Vai al Catalogo
      </button>
    </div>

    <!-- Cart Items -->
    <div class="cart-items" *ngIf="cartItems.length > 0">
      <div class="cart-item" *ngFor="let item of cartItems; trackBy: trackByCartItemId">
        <div class="cart-item-image">
          <img [src]="item.thumbnail_url || 'https://via.placeholder.com/60x60?text=No+Image'" 
               [alt]="item.article_name">
        </div>
        <div class="cart-item-details">
          <h4>{{ item.article_name }}</h4>
          <span class="item-price">{{ formatPv(item.pv_unit_price) }}</span>
          <div class="item-quantity-control">
            <button (click)="updateCartItemQuantity(item.id, item.quantity - 1)">
              <span class="material-icons">remove</span>
            </button>
            <span>{{ item.quantity }}</span>
            <button (click)="updateCartItemQuantity(item.id, item.quantity + 1)">
              <span class="material-icons">add</span>
            </button>
          </div>
        </div>
        <div class="cart-item-actions">
          <span class="item-total">{{ formatPv(item.pv_total) }}</span>
          <button class="remove-btn" (click)="removeFromCart(item.id)">
            <span class="material-icons">delete</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Cart Footer -->
    <div class="cart-footer" *ngIf="cartItems.length > 0">
      <div class="cart-summary">
        <div class="summary-row">
          <span>Articoli ({{ cartItemsCount }})</span>
          <span>{{ formatPv(cartTotalPv) }}</span>
        </div>
        <div class="summary-row pv-available">
          <span>PV Disponibili</span>
          <span>{{ formatPv(userBalance?.pv_disponibili || 0) }}</span>
        </div>
      </div>
      
      <button class="btn-checkout" 
              [disabled]="!canAffordCart()"
              (click)="goToCheckout()">
        <span class="material-icons">shopping_bag</span>
        <span>Procedi all'Ordine</span>
        <span class="checkout-total">{{ formatPv(cartTotalPv) }}</span>
      </button>

      <button class="btn-clear-cart" (click)="clearCart()">
        <span class="material-icons">delete_sweep</span>
        Svuota Carrello
      </button>
    </div>
  </aside>

  <!-- ===================================
       MOBILE BOTTOM NAVIGATION
       =================================== -->
  <nav class="mobile-nav" *ngIf="isMobile">
    <button class="mobile-nav-item" 
            [class.active]="mobileNavTab === 'catalog'"
            (click)="setMobileNavTab('catalog')">
      <span class="material-icons">store</span>
      <span>Catalogo</span>
    </button>
    <button class="mobile-nav-item" 
            [class.active]="mobileNavTab === 'cart'"
            (click)="setMobileNavTab('cart')">
      <span class="material-icons">shopping_cart</span>
      <span>Carrello</span>
      <span class="nav-badge" *ngIf="cartItemsCount > 0">{{ cartItemsCount }}</span>
    </button>
    <button class="mobile-nav-item" 
            [class.active]="mobileNavTab === 'orders'"
            (click)="setMobileNavTab('orders')">
      <span class="material-icons">receipt_long</span>
      <span>Ordini</span>
    </button>
    <button class="mobile-nav-item" 
            [class.active]="mobileNavTab === 'wallet'"
            (click)="setMobileNavTab('wallet')">
      <span class="material-icons">account_balance_wallet</span>
      <span>Wallet</span>
    </button>
  </nav>

  <!-- ===================================
       TOAST NOTIFICATIONS
       =================================== -->
  <div class="toast-container">
    <div class="toast" 
         *ngFor="let toast of toasts"
         [ngClass]="toast.type"
         [@toastAnimation]>
      <span class="material-icons toast-icon">
        {{ toast.type === 'success' ? 'check_circle' : toast.type === 'error' ? 'error' : 'info' }}
      </span>
      <div class="toast-content">
        <span class="toast-title">{{ toast.title }}</span>
        <span class="toast-message">{{ toast.message }}</span>
      </div>
      <button class="toast-close" (click)="removeToast(toast.id)">
        <span class="material-icons">close</span>
      </button>
    </div>
  </div>

</div>
