<!-- ticket-management.component.html -->
<div class="ticket-management-container" *ngIf="canManageTickets()" (click)="closeStatusDropdown($event)">
  
  <!-- Header -->
  <div class="top-header">
    <div class="header-title">
      <i class="fas fa-ticket-alt"></i>
      <div>
        <h2>Gestione Ticket</h2>
        <p>Sezione di gestione e monitoraggio dei ticket di supporto</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-new-ticket" (click)="createNewTicket()">
        <i class="fas fa-plus"></i>
        Nuovo Ticket
      </button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filter-header">
      <h3><i class="fas fa-filter"></i> Filtri di Ricerca</h3>
      <button class="btn-filter" (click)="toggleFilters()">
        <i class="fas" [class.fa-chevron-up]="showFilters" [class.fa-chevron-down]="!showFilters"></i>
      </button>
    </div>
    
    <div class="filters-grid" [class.filters-grid-visible]="showFilters">
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-hashtag"></i> ID Contratto
        </label>
        <input 
          type="number" 
          class="filter-input" 
          [(ngModel)]="filters.contractId"
          (input)="applyFilters()"
          placeholder="Inserisci ID contratto">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-file-contract"></i> Codice Contratto
        </label>
        <input 
          type="text" 
          class="filter-input" 
          [(ngModel)]="filters.contractCode"
          (input)="applyFilters()"
          placeholder="Inserisci codice contratto">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-box"></i> Prodotto
        </label>
        <select class="filter-input" [(ngModel)]="filters.product" (change)="applyFilters()">
          <option value="">Tutti i prodotti</option>
          <option *ngFor="let product of products" [value]="product">{{product}}</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-exclamation-triangle"></i> Priorità 
        </label>
        <select class="filter-input" [(ngModel)]="filters.priority" (change)="applyFilters()">
          <option value="">Tutte le Priorità</option>
          <option *ngFor="let priority of priorities" [value]="priority.value">{{priority.label}}</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-tasks"></i> Stato
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="toggleStatusDropdown()">
            <span class="multi-select-label">{{getSelectedStatusLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showStatusDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showStatusDropdown">
            <div class="multi-select-option" 
                 *ngFor="let column of columns"
                 (click)="toggleStatusFilter(column.id)">
              <div class="custom-checkbox" 
                   [style.background-color]="isStatusSelected(column.id) ? column.color : 'transparent'"
                   [style.border-color]="column.color">
                <i class="fas fa-check" *ngIf="isStatusSelected(column.id)"></i>
              </div>
              <span>{{column.title}}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user-tie"></i> SEU
        </label>
        <select class="filter-input" [(ngModel)]="filters.seu" (change)="applyFilters()">
          <option value="">Tutti i SEU</option>
          <option *ngFor="let seu of seuList" [value]="seu.id">{{seu.name}}</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user-edit"></i> Generato da
        </label>
        <select class="filter-input" [(ngModel)]="filters.generatedBy" (change)="applyFilters()">
          <option value="">Tutti gli utenti</option>
          <option *ngFor="let generator of generatorsList" [value]="generator.id">{{generator.name}}</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user-check"></i> Assegnato a
        </label>
        <select class="filter-input" [(ngModel)]="filters.assignedTo" (change)="applyFilters()">
          <option value="">Tutti gli utenti</option>
          <option value="0">Non assegnato</option>
          <option *ngFor="let user of users" [value]="user.id">
            {{user.name}} {{user.cognome}}
          </option>
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user"></i> Cliente
        </label>
        <input 
          type="text" 
          class="filter-input" 
          [(ngModel)]="filters.customer"
          (input)="applyFilters()"
          placeholder="Nome cliente">
      </div>
      
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-calendar-alt"></i> Data Apertura Ticket
        </label>
        <input 
          type="date" 
          class="filter-input" 
          [(ngModel)]="filters.openingDate"
          (change)="applyFilters()">
      </div>
    </div>
    
    <div class="filter-actions" [class.filter-actions-visible]="showFilters">
      <button class="btn-filter primary" (click)="applyFilters()">
        <i class="fas fa-search"></i> Applica Filtri
      </button>
      <button class="btn-filter" (click)="clearFilters()">
        <i class="fas fa-times"></i> Reset Filtri
      </button>
      <div style="margin-left: auto; color: #666; font-size: 14px;">
        <i class="fas fa-ticket-alt"></i> {{filteredTickets.length}} ticket trovati
      </div>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="kanban-container">
    <div class="kanban-board" [attr.data-visible-columns]="getVisibleColumnsCount()">
      <div 
        *ngFor="let column of columns" 
        class="kanban-column"
        [class]="'status-' + column.id"
        [class.column-hidden]="!isColumnVisible(column.id)"
        [style.flex]="isColumnVisible(column.id) ? '1' : '0'"
        (drop)="onTicketDrop($event, column.id)"
        (dragover)="onDragOver($event)">
        
        <div class="column-header">
          <div class="column-title">
            <i [class]="column.icon" [style.color]="column.color"></i>
            <span>{{column.title}}</span>
          </div>
          <span class="column-count">{{column.count}}</span>
        </div>
        
        <div class="column-body">
          <!-- Ticket Card with Minimize/Expand functionality -->
          <div 
            *ngFor="let ticket of getTicketsForColumn(column.id)" 
            class="ticket-card"
            [class.ticket-minimized]="isTicketMinimized(ticket.id)"
            [class]="'ticket-status-' + column.id"
            draggable="true"
            (dragstart)="onTicketDragStart($event, ticket)"
            (click)="openTicketModal(ticket)">
            
            <!-- MINIMIZED VIEW - Compact single row -->
            <div class="ticket-minimized-view" *ngIf="isTicketMinimized(ticket.id)">
              <span class="ticket-id-mini">#{{ticket.ticket_number}}</span>
              <span class="ticket-title-mini" [class]="'title-' + ticket.status" [title]="ticket.title">
                {{truncateText(ticket.title, 25)}}
              </span>
              <span 
                class="ticket-priority-mini"
                [class]="'priority-' + ticket.priority"
                [style.background-color]="getPriorityColor(ticket.priority)">
                {{getPriorityLabel(ticket.priority)}}
              </span>
              <button class="btn-expand" (click)="toggleMinimizeTicket(ticket.id, $event)" title="Expand ticket">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>

            <!-- EXPANDED VIEW - Full ticket details -->
            <div class="ticket-expanded-view" *ngIf="!isTicketMinimized(ticket.id)">
              <div class="ticket-header">
                <span class="ticket-id">#{{ticket.ticket_number}}</span>
                <div class="ticket-header-actions">
                  <span 
                    class="ticket-priority"
                    [class]="'priority-' + ticket.priority"
                    [style.background-color]="getPriorityColor(ticket.priority)">
                    {{getPriorityLabel(ticket.priority)}}
                  </span>
                  <button class="btn-minimize" (click)="toggleMinimizeTicket(ticket.id, $event)" title="Minimize ticket">
                    <i class="fas fa-chevron-up"></i>
                  </button>
                </div>
              </div>
              
              <div class="ticket-info-row">
                <i class="fas fa-hashtag"></i>
                <span><strong>ID Contratto:</strong> {{ticket.contract_id}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-box"></i>
                <span><strong>Prodotto:</strong> {{ticket.product_name}}</span>
              </div>
              
              <div class="ticket-title" [class]="'title-' + ticket.status">{{ticket.title}}</div>
              
              <div class="ticket-info-row">
                <i class="fas fa-user"></i>
                <span><strong>Cliente:</strong> {{ticket.customer_name}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-user-edit"></i>
                <span><strong>Generato Da:</strong> {{ticket.created_by_user_name || 'N/A'}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-user-tie"></i>
                <span><strong>SEU:</strong> {{ticket.seu_name}}</span>
              </div>

              <div class="ticket-meta">
                <div class="ticket-assigned">
                  <i class="fas fa-user-check"></i>
                  <span><strong>Assegnato A:</strong> {{getAssignedUserName(ticket)}}</span>
                </div>
                <span class="ticket-date">{{getTimeAgo(ticket.created_at)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ticket Detail Modal -->
<div class="modal-overlay" *ngIf="showTicketModal" (click)="closeTicketModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-ticket-alt"></i>
        <span>Dettaglio Ticket #{{selectedTicket?.ticket_number}}</span>
      </div>
      <button class="close-btn" (click)="closeTicketModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedTicket">
      <div class="ticket-detail-info">
        <div class="info-grid">
          <div class="info-item">
            <label>Titolo:</label>
            <span>{{selectedTicket.title}}</span>
          </div>
          <div class="info-item">
            <label>Stato:</label>
            <span class="status-badge" [style.background-color]="statusColorMap[selectedTicket.status]">
              {{getColumnTitle(selectedTicket.status)}}
            </span>
          </div>
          <div class="info-item">
            <label>Priorità:</label>
            <span class="priority-badge" [style.background-color]="getPriorityColor(selectedTicket.priority)">
              {{getPriorityLabel(selectedTicket.priority)}}
            </span>
          </div>
          <div class="info-item">
            <label>Cliente:</label>
            <span>{{selectedTicket.customer_name}}</span>
          </div>
          <div class="info-item">
            <label>Contratto:</label>
            <span>{{selectedTicket.contract_code}}</span>
          </div>
          <div class="info-item">
            <label>Assegnato a:</label>
            <span>{{getAssignedUserName(selectedTicket)}}</span>
          </div>
        </div>

        <div class="description-section">
          <label>Descrizione:</label>
          <p>{{selectedTicket.description}}</p>
        </div>
      </div>

      <div class="messages-section">
        <h3>Conversazione</h3>
        <div class="messages-container">
          <div class="loading-messages" *ngIf="isLoadingMessages">
            <i class="fas fa-spinner fa-spin"></i> Caricamento messaggi...
          </div>
          <div class="message" 
               *ngFor="let message of selectedTicket.messages" 
               [class.message-own]="message.user_id === currentUser.id"
               [class.status-change-message]="isStatusChangeMessage(message)">
            <!-- Avatar for regular messages only -->
            <div class="message-avatar" 
                 *ngIf="!isStatusChangeMessage(message)"
                 [style.background-color]="message.user_id === currentUser?.id ? '#28a745' : '#007bff'">
                {{getInitials(message.user_name || 'User')}}
            </div>
            
            <div class="message-content" [class.status-change-content]="isStatusChangeMessage(message)">
              <!-- Regular message header -->
              <div class="message-header" *ngIf="!isStatusChangeMessage(message)">
                <span class="message-author">{{message.user_name}}</span>
                <span class="message-time">{{getTimeAgo(message.created_at)}}</span>
              </div>
              
              <!-- Regular message bubble -->
              <div class="message-bubble" *ngIf="!isStatusChangeMessage(message)">
                {{message.message}}
              </div>
              
              <!-- Status change message bubble with gradient -->
              <div class="message-bubble status-change-bubble" 
                   *ngIf="isStatusChangeMessage(message)"
                   [ngStyle]="{'background': getStatusChangeGradient(message)}">
                <i class="fas fa-exchange-alt status-change-icon"></i>
                <span class="status-change-text">{{message.message}}</span>
                <span class="status-change-time">{{getTimeAgo(message.created_at)}}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="message-input-container">
          <input 
            type="text" 
            [(ngModel)]="newMessage" 
            placeholder="Scrivi un messaggio..."
            (keyup.enter)="sendMessage()"
            class="message-input">
          <button class="send-btn" (click)="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Ticket Modal -->
<div class="modal-overlay" *ngIf="showNewTicketModal" (click)="closeNewTicketModal()">
  <div class="modal-container" [class.shake]="isShaking" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-plus-circle"></i>
        <span>Nuovo Ticket</span>
      </div>
      <button class="close-btn" (click)="closeNewTicketModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form>
        <div class="form-group">
          <label>Contratto <span class="required">*</span></label>
          <select 
            [(ngModel)]="newTicket.contract_id" 
            name="contractId" 
            required 
            class="form-control"
            [class.error]="showValidationError && !newTicket.contract_id">
            <option [value]="null" disabled>Seleziona un contratto</option>
            <option *ngFor="let contract of contracts" [value]="contract.id">
              {{contract.codice_contratto}} - {{contract.customer_data?.nome || contract.customer_data?.ragione_sociale}}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Titolo <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="newTicket.title" 
            name="title" 
            required 
            class="form-control"
            [class.error]="showValidationError && !newTicket.title"
            placeholder="Inserisci il titolo del ticket">
        </div>
        
        <div class="form-group">
          <label>Descrizione <span class="required">*</span></label>
          <textarea 
            [(ngModel)]="newTicket.description" 
            name="description" 
            required 
            class="form-control"
            [class.error]="showValidationError && !newTicket.description"
            rows="4"
            placeholder="Descrivi il problema o la richiesta..."></textarea>
        </div>
        
        <div class="form-group">
          <label>Priorità </label>
          <select [(ngModel)]="newTicket.priority" name="priority" class="form-control">
            <option *ngFor="let priority of priorities" [value]="priority.value">
              {{priority.label}}
            </option>
          </select>
        </div>

        <div class="validation-message" *ngIf="showValidationError">
          <i class="fas fa-exclamation-triangle"></i>
          Compila tutti i campi obbligatori contrassegnati con *
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeNewTicketModal()">
            Annulla
          </button>
          <button type="button" class="btn btn-primary" (click)="saveNewTicket()">
            <i class="fas fa-save"></i> Crea Ticket
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Access Denied Message -->
<div class="access-denied" *ngIf="!canManageTickets()">
  <div class="access-denied-content">
    <i class="fas fa-lock"></i>
    <h2>Accesso Negato</h2>
    <p>Solo gli amministratori e i membri del backoffice possono accedere alla gestione ticket.</p>
  </div>
</div>