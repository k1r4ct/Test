<div class="ticket-management-container" *ngIf="canManageTickets()" (click)="closeStatusDropdown($event)">
  
  <!-- ==================== HEADER ==================== -->
  <div class="top-header">
    <div class="header-title">
      <i class="fas fa-ticket-alt"></i>
      <div>
        <h2>Gestione Ticket</h2>
        <p>Sezione di gestione e monitoraggio dei ticket di supporto</p>
      </div>
    </div>
    <div class="header-actions">
      <!-- Ticket count -->
      <span class="ticket-count">
        <i class="fas fa-inbox"></i>
        {{filteredTickets.length}} ticket trovati
      </span>

      <!-- Archive button (BackOffice & WebOps) -->
      <button 
        *ngIf="!isAdmin" 
        class="btn-archive" 
        [class.active]="showClosedColumn"
        (click)="toggleClosedColumn()"
        title="Mostra/Nascondi archivio">
        <i class="fas fa-archive"></i>
        Archivio
      </button>

      <!-- Archive button (Admin - positioned before delete buttons) -->
      <button 
        *ngIf="isAdmin" 
        class="btn-archive" 
        [class.active]="showClosedColumn"
        (click)="toggleClosedColumn()"
        title="Mostra/Nascondi archivio">
        <i class="fas fa-archive"></i>
        Archivio
      </button>

      <!-- Delete Tickets button (Admin only) -->
      <button 
        *ngIf="isAdmin" 
        class="btn-delete-tickets"
        [disabled]="selectedTicketsForDeletion.size === 0"
        (click)="bulkDeleteTickets()"
        title="Cancella ticket selezionati">
        <i class="fas fa-trash"></i>
        Cancella Ticket ({{selectedTicketsForDeletion.size}})
      </button>

      <!-- Show Deleted button (Admin only) -->
      <button 
        *ngIf="isAdmin" 
        class="btn-show-deleted"
        [class.active]="showDeletedColumn"
        (click)="toggleDeletedColumn()"
        [title]="showDeletedColumn ? 'Nascondi ticket cancellati' : 'Mostra ticket cancellati'">
        <i class="fas" [class.fa-eye]="!showDeletedColumn" [class.fa-eye-slash]="showDeletedColumn"></i>
        {{getDeletedButtonText()}}
      </button>

      <!-- New Ticket button -->
      <button class="btn-new-ticket" (click)="createNewTicket()">
        <i class="fas fa-plus"></i>
        Nuovo Ticket
      </button>
    </div>
  </div>

  <!-- ==================== FILTERS SECTION ==================== -->
  <div class="filters-section">
    <div class="filter-header">
      <h3><i class="fas fa-filter"></i> Filtri di Ricerca</h3>
      <button class="btn-filter" (click)="toggleFilters()">
        <i class="fas" [class.fa-chevron-up]="showFilters" [class.fa-chevron-down]="!showFilters"></i>
      </button>
    </div>
    
    <div class="filters-grid" [class.filters-grid-visible]="showFilters">
      
      <!-- ID Contratto -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-hashtag"></i> ID Contratto
        </label>
        <input 
          type="number" 
          class="filter-input" 
          [(ngModel)]="filters.contractId"
          (input)="applyFilters()"
          placeholder="Inserisci ID contratto">
      </div>
      
      <!-- Codice Contratto -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-file-contract"></i> Codice Contratto
        </label>
        <input 
          type="text" 
          class="filter-input" 
          [(ngModel)]="filters.contractCode"
          (input)="applyFilters()"
          placeholder="Inserisci codice contratto">
      </div>
      
      <!-- Prodotto Multi-Select -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-box"></i> Prodotto
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="toggleProductDropdown(); $event.stopPropagation()">
            <span class="multi-select-label">{{getSelectedProductLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showProductDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showProductDropdown" (click)="$event.stopPropagation()">
            <div style="padding: 10px; border-bottom: 1px solid #e9ecef;">
              <input 
                type="text" 
                class="filter-input" 
                placeholder="Cerca prodotto..."
                [(ngModel)]="productSearchQuery"
                (input)="filterProducts()"
                style="margin: 0; width: 100%;">
            </div>
            <div class="multi-select-option" 
                 *ngFor="let product of filteredProducts"
                 (click)="toggleProductFilter(product)">
              <div class="custom-checkbox" 
                   [style.background-color]="isProductSelected(product) ? '#28a745' : 'transparent'"
                   [style.border-color]="isProductSelected(product) ? '#28a745' : '#dee2e6'">
                <i class="fas fa-check" *ngIf="isProductSelected(product)"></i>
              </div>
              <span>{{product}}</span>
            </div>
            <div *ngIf="filteredProducts.length === 0" style="padding: 20px; text-align: center; color: #999;">
              Nessun prodotto trovato
            </div>
          </div>
        </div>
      </div>
      
      <!-- Priorità Multi-Select -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-exclamation-triangle"></i> Priorità
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="togglePriorityDropdown(); $event.stopPropagation()">
            <span class="multi-select-label">{{getSelectedPriorityLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showPriorityDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showPriorityDropdown" (click)="$event.stopPropagation()">
            <div class="multi-select-option" 
                 *ngFor="let priority of priorities"
                 (click)="togglePriorityFilter(priority.value)">
              <div class="custom-checkbox" 
                   [style.background-color]="isPrioritySelected(priority.value) ? priority.color : 'transparent'"
                   [style.border-color]="priority.color">
                <i class="fas fa-check" *ngIf="isPrioritySelected(priority.value)"></i>
              </div>
              <span>{{priority.label}}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stato Multi-Select -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-tasks"></i> Stato
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="toggleStatusDropdown(); $event.stopPropagation()">
            <span class="multi-select-label">{{getSelectedStatusLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showStatusDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showStatusDropdown" (click)="$event.stopPropagation()">
            <div class="multi-select-option" 
                 *ngFor="let column of columns"
                 [hidden]="column.hidden"
                 (click)="toggleStatusFilter(column.id)">
              <div class="custom-checkbox" 
                   [style.background-color]="isStatusSelected(column.id) ? column.color : 'transparent'"
                   [style.border-color]="column.color">
                <i class="fas fa-check" *ngIf="isStatusSelected(column.id)"></i>
              </div>
              <span>{{column.title}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- SEU Multi-Select -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user-tie"></i> SEU
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="toggleSeuDropdown(); $event.stopPropagation()">
            <span class="multi-select-label">{{getSelectedSeuLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showSeuDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showSeuDropdown" (click)="$event.stopPropagation()">
            <div style="padding: 10px; border-bottom: 1px solid #e9ecef;">
              <input 
                type="text" 
                class="filter-input" 
                placeholder="Cerca SEU..."
                [(ngModel)]="seuSearchQuery"
                (input)="filterSeu()"
                style="margin: 0; width: 100%;">
            </div>
            <div class="multi-select-option" 
                 *ngFor="let seu of filteredSeuList"
                 (click)="toggleSeuFilter(seu.id.toString())">
              <div class="custom-checkbox" 
                   [style.background-color]="isSeuSelected(seu.id.toString()) ? '#28a745' : 'transparent'"
                   [style.border-color]="'#28a745'">
                <i class="fas fa-check" *ngIf="isSeuSelected(seu.id.toString())"></i>
              </div>
              <span>{{seu.name}}</span>
            </div>
            <div *ngIf="filteredSeuList.length === 0" style="padding: 20px; text-align: center; color: #999;">
              Nessun SEU trovato
            </div>
          </div>
        </div>
      </div>

      <!-- Generato da Multi-Select -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user-edit"></i> Generato da
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="toggleGeneratedByDropdown(); $event.stopPropagation()">
            <span class="multi-select-label">{{getSelectedGeneratedByLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showGeneratedByDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showGeneratedByDropdown" (click)="$event.stopPropagation()">
            <div style="padding: 10px; border-bottom: 1px solid #e9ecef;">
              <input 
                type="text" 
                class="filter-input" 
                placeholder="Cerca utente..."
                [(ngModel)]="generatedBySearchQuery"
                (input)="filterGenerators()"
                style="margin: 0; width: 100%;">
            </div>
            <div class="multi-select-option" 
                 *ngFor="let generator of filteredGeneratorsList"
                 (click)="toggleGeneratedByFilter(generator.id.toString())">
              <div class="custom-checkbox" 
                   [style.background-color]="isGeneratedBySelected(generator.id.toString()) ? '#28a745' : 'transparent'"
                   [style.border-color]="'#28a745'">
                <i class="fas fa-check" *ngIf="isGeneratedBySelected(generator.id.toString())"></i>
              </div>
              <span>{{generator.name}}</span>
            </div>
            <div *ngIf="filteredGeneratorsList.length === 0" style="padding: 20px; text-align: center; color: #999;">
              Nessun utente trovato
            </div>
          </div>
        </div>
      </div>

      <!-- Assegnato a Multi-Select -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user-check"></i> Assegnato a
        </label>
        <div class="multi-select-container">
          <div class="multi-select-trigger" (click)="toggleAssignedToDropdown(); $event.stopPropagation()">
            <span class="multi-select-label">{{getSelectedAssignedToLabels()}}</span>
            <i class="fas fa-chevron-down" [class.fa-chevron-up]="showAssignedToDropdown"></i>
          </div>
          <div class="multi-select-dropdown" *ngIf="showAssignedToDropdown" (click)="$event.stopPropagation()">
            <div style="padding: 10px; border-bottom: 1px solid #e9ecef;">
              <input 
                type="text" 
                class="filter-input" 
                placeholder="Cerca utente..."
                [(ngModel)]="assignedToSearchQuery"
                (input)="filterAssignedTo()"
                style="margin: 0; width: 100%;">
            </div>
            <div class="multi-select-option" (click)="toggleAssignedToFilter('0')">
              <div class="custom-checkbox" 
                   [style.background-color]="isAssignedToSelected('0') ? '#6c757d' : 'transparent'"
                   [style.border-color]="'#6c757d'">
                <i class="fas fa-check" *ngIf="isAssignedToSelected('0')"></i>
              </div>
              <span>Non assegnato</span>
            </div>
            <div class="multi-select-option" 
                 *ngFor="let user of filteredUsers"
                 (click)="toggleAssignedToFilter(user.id.toString())">
              <div class="custom-checkbox" 
                   [style.background-color]="isAssignedToSelected(user.id.toString()) ? '#28a745' : 'transparent'"
                   [style.border-color]="'#28a745'">
                <i class="fas fa-check" *ngIf="isAssignedToSelected(user.id.toString())"></i>
              </div>
              <span>{{user.name}} {{user.cognome}}</span>
            </div>
            <div *ngIf="filteredUsers.length === 0 && assignedToSearchQuery" style="padding: 20px; text-align: center; color: #999;">
              Nessun utente trovato
            </div>
          </div>
        </div>
      </div>
      
      <!-- Cliente -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-user"></i> Cliente
        </label>
        <input 
          type="text" 
          class="filter-input" 
          [(ngModel)]="filters.customer"
          (input)="applyFilters()"
          placeholder="Nome cliente">
      </div>
      
      <!-- Data Apertura Ticket -->
      <div class="filter-group">
        <label class="filter-label">
          <i class="fas fa-calendar-alt"></i> Data Apertura Ticket
        </label>
        <input 
          type="date" 
          class="filter-input" 
          [(ngModel)]="filters.openingDate"
          (change)="applyFilters()">
      </div>
    </div>
    
    <div class="filter-actions" [class.filter-actions-visible]="showFilters">
      <button class="btn-filter primary" (click)="applyFilters()">
        <i class="fas fa-search"></i> Applica Filtri
      </button>
      <button class="btn-filter" (click)="clearFilters()">
        <i class="fas fa-times"></i> Reset Filtri
      </button>
    </div>
  </div>

  <!-- ==================== KANBAN BOARD ==================== -->
  <div class="kanban-container">
    <div class="kanban-board" [attr.data-visible-columns]="getVisibleColumnsCount()">
      <div 
        *ngFor="let column of columns" 
        class="kanban-column"
        [class]="'status-' + column.id"
        [class.column-hidden]="!isColumnVisible(column.id)"
        [style.flex]="!column.hidden ? '1' : '0'"
        (drop)="onTicketDrop($event, column.id)"
        (dragover)="onDragOver($event)">
        
        <div class="column-header">
          <div class="column-title">
            <i [class]="column.icon" [style.color]="column.color"></i>
            <span>{{column.title}}</span>
          </div>
          <span class="column-count">{{column.count}}</span>
        </div>
        
        <div class="column-body">
          <!-- Ticket Card with Minimize/Expand functionality -->
          <div 
            *ngFor="let ticket of getTicketsForColumn(column.id)" 
            class="ticket-card"
            [class.ticket-minimized]="isTicketMinimized(ticket.id)"
            [class.ticket-not-draggable]="!canDragTicket(ticket)"
            [class]="'ticket-status-' + column.id"
            [class.resolved-column]="column.id === 'resolved'"
            [attr.draggable]="true"
            (dragstart)="onTicketDragStart($event, ticket)"
            (dragend)="onTicketDragEnd()"
            (click)="openTicketModal(ticket)">
            
            <!-- Ban icon -->
            <div class="ticket-ban-icon" *ngIf="shouldShowBanIcon(ticket)">
              <i class="fas fa-ban"></i>
            </div>
            
            <!-- MINIMIZED VIEW - Compact single row with checkbox -->
            <div class="ticket-minimized-view" *ngIf="isTicketMinimized(ticket.id)">
              <!-- Selection checkbox for minimized tickets -->
              <div 
                *ngIf="isAdmin && ticket.status !== 'deleted'" 
                class="ticket-select-checkbox-mini"
                (click)="selectTicketForDeletion(ticket.id, $event)">
                <i 
                  class="fas" 
                  [class.fa-square]="!selectedTicketsForDeletion.has(ticket.id)"
                  [class.fa-check-square]="selectedTicketsForDeletion.has(ticket.id)"
                  [style.color]="selectedTicketsForDeletion.has(ticket.id) ? '#f44336' : '#ccc'">
                </i>
              </div>
              
              <span class="ticket-id-mini">#{{ticket.ticket_number}}</span>
              <span class="ticket-title-mini" [class]="'title-' + ticket.status" [title]="ticket.title">
                {{truncateText(ticket.title, 25)}}
              </span>
              
              <!-- Attachments Badge (minimized) -->
              <div class="attachments-badge" *ngIf="(ticket.attachments_count ?? 0) > 0" title="{{ticket.attachments_count ?? 0}} allegati">
                <i class="fas fa-paperclip"></i>
                <span>{{ticket.attachments_count ?? 0}}</span>
              </div>
              
              <!-- Priority badge with dropdown in minimized view -->
              <div class="priority-dropdown-wrapper" (click)="$event.stopPropagation()">
                <span 
                  class="ticket-priority-mini clickable-priority"
                  [class]="'priority-' + ticket.priority"
                  [style.background-color]="getPriorityColor(ticket.priority)"
                  (click)="togglePriorityDropdownForTicket(ticket.id, $event)"
                  title="Clicca per cambiare priorità">
                  {{getPriorityLabel(ticket.priority)}}
                </span>
                
                <!-- Priority dropdown menu -->
                <div class="priority-dropdown-menu" *ngIf="isPriorityDropdownOpen(ticket.id)">
                  <div 
                    class="priority-option"
                    *ngFor="let priority of priorities"
                    (click)="changeTicketPriority(ticket, priority.value, $event)">
                    <div 
                      class="priority-color-indicator"
                      [style.background-color]="priority.color">
                    </div>
                    <span>{{priority.label}}</span>
                    <i class="fas fa-check" *ngIf="ticket.priority === priority.value"></i>
                  </div>
                </div>
              </div>
              
              <button class="btn-expand" (click)="toggleMinimizeTicket(ticket.id, $event)" title="Espandi ticket">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>

            <!-- EXPANDED VIEW - Full ticket details -->
            <div class="ticket-expanded-view" *ngIf="!isTicketMinimized(ticket.id)">
              <!-- Unified header row with all controls -->
              <div class="ticket-header-unified">
              <!-- Selection checkbox (admin only, not in deleted column) -->
              <div 
                *ngIf="isAdmin && ticket.status !== 'deleted'" 
                class="ticket-select-checkbox-inline"
                (click)="selectTicketForDeletion(ticket.id, $event)">
                <i 
                  class="fas" 
                  [class.fa-square]="!selectedTicketsForDeletion.has(ticket.id)"
                  [class.fa-check-square]="selectedTicketsForDeletion.has(ticket.id)"
                  [style.color]="selectedTicketsForDeletion.has(ticket.id) ? '#f44336' : '#ccc'">
                </i>
              </div>
              
              <span class="ticket-id">#{{ticket.ticket_number}}</span>

              <!-- Attachments Badge (expanded) -->
              <div
                class="attachments-badge"
                *ngIf="(ticket.attachments_count ?? 0) > 0"
                title="{{ticket.attachments_count ?? 0}} allegati">
                <i class="fas fa-paperclip"></i>
                <span>{{ticket.attachments_count ?? 0}}</span>
              </div>

              <!-- CONTENITORE DI DESTRA -->
              <div class="ticket-header-controls">
                <!-- PRIORITÀ SEMPRE QUI -->
                <div class="priority-dropdown-wrapper" (click)="$event.stopPropagation()">
                  <span 
                    class="ticket-priority clickable-priority"
                    [class]="'priority-' + ticket.priority"
                    [style.background-color]="getPriorityColor(ticket.priority)"
                    (click)="togglePriorityDropdownForTicket(ticket.id, $event)"
                    title="Clicca per cambiare priorità">
                    {{ getPriorityLabel(ticket.priority) }}
                  </span>
                  
                  <div class="priority-dropdown-menu" *ngIf="isPriorityDropdownOpen(ticket.id)">
                    <div 
                      class="priority-option"
                      *ngFor="let priority of priorities"
                      (click)="changeTicketPriority(ticket, priority.value, $event)">
                      <div 
                        class="priority-color-indicator"
                        [style.background-color]="priority.color">
                      </div>
                      <span>{{ priority.label }}</span>
                      <i class="fas fa-check" *ngIf="ticket.priority === priority.value"></i>
                    </div>
                  </div>
                </div>

                <!-- SOLO IN RISOLTO: bottone archivia -->
                <div 
                  *ngIf="ticket.status === 'resolved' && canCloseTicket(ticket)" 
                  class="ticket-close-btn-inline"
                  (click)="closeTicket(ticket, $event)"
                  title="Archivia e chiudi ticket">
                  <i class="fas fa-check-circle"></i>
                </div>
                
                <!-- Sempre per ultimo: minimizza -->
                <button
                  class="btn-minimize"
                  (click)="toggleMinimizeTicket(ticket.id, $event)"
                  title="Minimizza ticket">
                  <i class="fas fa-chevron-up"></i>
                </button>
              </div>
            </div>
              
              <div class="ticket-info-row">
                <i class="fas fa-hashtag"></i>
                <span><strong>ID Contratto:</strong> {{ticket.contract_id}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-file-contract"></i>
                <span><strong>Codice:</strong> {{ticket.contract_code}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-box"></i>
                <span><strong>Prodotto:</strong> {{ticket.product_name}}</span>
              </div>
              
              <div class="ticket-title" [class]="'title-' + ticket.status">{{ticket.title}}</div>
              
              <div class="ticket-info-row">
                <i class="fas fa-user"></i>
                <span><strong>Cliente:</strong> {{ticket.customer_name}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-user-edit"></i>
                <span><strong>Generato Da:</strong> {{ticket.created_by_user_name || 'N/A'}}</span>
              </div>

              <div class="ticket-info-row">
                <i class="fas fa-user-tie"></i>
                <span><strong>SEU:</strong> {{ticket.seu_name}}</span>
              </div>

              <!-- Attachment indicator in ticket card -->
              <div class="ticket-info-row" *ngIf="ticket.attachments_count && ticket.attachments_count > 0">
                <i class="fas fa-paperclip"></i>
                <span><strong>Allegati:</strong> {{ticket.attachments_count}}</span>
              </div>

              <div class="ticket-meta">
                <div class="ticket-assigned">
                  <i class="fas fa-user-check"></i>
                  <span><strong>Assegnato A:</strong> {{getAssignedUserName(ticket)}}</span>
                </div>
                <span class="ticket-date">{{getTimeAgo(ticket.created_at)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== TICKET DETAIL MODAL ==================== -->
<div class="modal-overlay" *ngIf="showTicketModal" (click)="closeTicketModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-ticket-alt"></i>
        <span>Dettaglio Ticket #{{selectedTicket?.ticket_number}}</span>
      </div>
      <button class="close-btn" (click)="closeTicketModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedTicket">
      <div class="ticket-detail-info">
        <div class="info-grid">
          <div class="info-item">
            <label>Titolo:</label>
            <span>{{selectedTicket.title}}</span>
          </div>
          <div class="info-item">
            <label>Stato:</label>
            <span class="status-badge" [style.background-color]="statusColorMap[selectedTicket.status]">
              {{getColumnTitle(selectedTicket.status)}}
            </span>
          </div>
          <div class="info-item">
            <label>Priorità:</label>
            <span class="priority-badge" [style.background-color]="getPriorityColor(selectedTicket.priority)">
              {{getPriorityLabel(selectedTicket.priority)}}
            </span>
          </div>
          <div class="info-item">
            <label>Cliente:</label>
            <span>{{selectedTicket.customer_name}}</span>
          </div>
          <div class="info-item">
            <label>Prodotto:</label>
            <span>{{selectedTicket.product_name}}</span>
          </div>
          <div class="info-item">
            <label>ID contratto:</label>
            <span>{{selectedTicket.contract_id}}</span>
          </div>
          <div class="info-item">
            <label>Codice contratto:</label>
            <span>{{selectedTicket.contract_code}}</span>
          </div>
          <div class="info-item">
            <label>Generato da:</label>
            <span>{{selectedTicket.created_by_user_name || 'N/A'}}</span>
          </div>
          <div class="info-item">
            <label>Assegnato a:</label>
            <span>{{getAssignedUserName(selectedTicket)}}</span>
          </div>
        </div>

        <div class="description-section">
          <label>Descrizione:</label>
          <p>{{selectedTicket.description}}</p>
        </div>
      </div>

      <!-- ==================== ATTACHMENTS SECTION (MODIFIED) ==================== -->
      <div class="attachments-section" *ngIf="ticketAttachments.length > 0 || isLoadingAttachments">
        <h3>
          <i class="fas fa-paperclip"></i> 
          Allegati ({{ticketAttachments.length}})
        </h3>
        
        <div class="loading-attachments" *ngIf="isLoadingAttachments">
          <i class="fas fa-spinner fa-spin"></i> Caricamento allegati...
        </div>
        
        <div class="attachments-grid" *ngIf="!isLoadingAttachments && ticketAttachments.length > 0">
          <div *ngFor="let attachment of ticketAttachments" 
               class="attachment-card clickable-attachment"
               (click)="openAttachmentPreview(attachment, false)"
               [title]="'Clicca per visualizzare: ' + attachment.original_name">
            <div class="attachment-icon">
              <i class="fas" [class]="getAttachmentIcon(attachment.original_name)"></i>
            </div>
            <div class="attachment-info">
              <div class="attachment-title">{{attachment.original_name}}</div>
              <div class="attachment-meta">
                <span class="attachment-size">{{formatFileSize(attachment.file_size)}}</span>
                <span class="attachment-user">
                  <i class="fas fa-user"></i>
                  {{attachment.user_name}}
                </span>
              </div>
            </div>
            <div class="attachment-actions">
              <button 
                class="download-btn"
                (click)="downloadAttachment(attachment); $event.stopPropagation()"
                title="Scarica">
                <i class="fas fa-download"></i>
              </button>
              <button 
                *ngIf="canDeleteAttachment(attachment)"
                class="delete-btn"
                (click)="deleteAttachment(attachment); $event.stopPropagation()"
                title="Elimina">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== MESSAGES SECTION (MODIFIED) ==================== -->
      <div class="messages-section">
        <h3>Conversazione</h3>
        <div class="messages-container">
          <div class="loading-messages" *ngIf="isLoadingMessages">
            <i class="fas fa-spinner fa-spin"></i> Caricamento messaggi...
          </div>
          <div class="message" 
              *ngFor="let message of selectedTicket.messages" 
              [class.message-own]="message.user_id === currentUser.id"
              [class.status-change-message]="isStatusChangeMessage(message)">
            <!-- Avatar for regular messages only -->
            <div class="message-avatar" 
                *ngIf="!isStatusChangeMessage(message)"
                [style.background-color]="getUserColor(message.user_id)">
              {{ message.role_letter || getUserRoleInitial(message.user_role) }}
            </div>
            
            <div class="message-content" [class.status-change-content]="isStatusChangeMessage(message)">
              <div class="message-author-label" *ngIf="!isStatusChangeMessage(message)"> 
                {{ getMessageAuthor(message) }}
              </div>
              
              <!-- Regular message bubble -->
              <div class="message-bubble" *ngIf="!isStatusChangeMessage(message)">
                <div class="bubble-text">{{message.message}}</div>
                
                <!-- Display attachments if present (MODIFIED) -->
                <div *ngIf="message.attachments && message.attachments.length > 0" 
                     class="message-attachments">
                  <div class="attachments-header">
                    <i class="fas fa-paperclip"></i>
                    <span>{{ message.attachments.length }} {{ message.attachments.length === 1 ? 'allegato' : 'allegati' }}</span>
                  </div>
                  <div class="attachments-list">
                    <div *ngFor="let attachment of message.attachments"
                         class="attachment-item clickable-attachment"
                         (click)="openAttachmentPreview(attachment, false)"
                         [title]="'Clicca per visualizzare: ' + attachment.original_name">
                      <i class="fas" [class]="getAttachmentIcon(attachment.original_name)"></i>
                      <span class="attachment-name">{{ attachment.original_name }}</span>
                      <span class="attachment-size">({{ formatFileSize(attachment.file_size) }})</span>
                      <i class="fas fa-eye preview-icon"></i>
                      <button 
                        *ngIf="canDeleteAttachment(attachment)"
                        class="delete-attachment-btn"
                        (click)="deleteAttachment(attachment); $event.stopPropagation()"
                        title="Elimina allegato">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Time inside bubble -->
                <div class="bubble-time">{{formatMessageTime(message.created_at)}}</div>
              </div>
              
              <!-- Status change message bubble with gradient -->
              <div class="message-bubble status-change-bubble" 
                   *ngIf="isStatusChangeMessage(message)"
                   [ngStyle]="{'background': getStatusChangeGradient(message)}">
                <i class="fas fa-exchange-alt status-change-icon"></i>
                <span class="status-change-text">{{message.message}}</span>
                <span class="status-change-time">{{getTimeAgo(message.created_at)}}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="chat-disabled-message" *ngIf="!canReplyToTicket(selectedTicket)">
          <i class="fas fa-info-circle"></i>
          Non puoi rispondere a questo ticket perché non è stato assegnato a te
        </div>
        
        <!-- ==================== MESSAGE INPUT WITH ATTACHMENTS (MODIFIED) ==================== -->
        <div class="message-input-container">
          <div class="reply-attachments-area" 
               *ngIf="canAttachToTicket(selectedTicket)"
               [class.drag-over]="isDraggingFile"
               (dragover)="onFileDragOver($event)"
               (dragleave)="onFileDragLeave($event)"
               (drop)="onFileDrop($event)">
            <input 
              type="file" 
              #replyFileInput
              style="display: none"
              multiple
              (change)="onReplyFilesSelected($event)"
              accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt,.zip">
            
            <div class="attachment-drop-zone" 
                 *ngIf="replyAttachments.length === 0"
                 (click)="replyFileInput.click()">
              <i class="fas fa-paperclip attachment-icon-large"></i>
              <p>Clicca o trascina qui il file che vuoi allegare</p>
              <span class="attachment-hint">Max {{maxFiles}} file, {{formatFileSize(maxFileSize)}} ciascuno</span>
            </div>
            
            <!-- Selected files preview (MODIFIED) -->
            <div class="selected-files-chips" *ngIf="replyAttachments.length > 0">
              <div *ngFor="let file of replyAttachments; let i = index" 
                   class="file-chip clickable-attachment"
                   (click)="openPendingAttachmentPreview(file, i)"
                   [title]="'Clicca per visualizzare: ' + file.name">
                <i class="fas fa-file"></i>
                <span>{{file.name}}</span>
                <i class="fas fa-eye preview-icon-chip"></i>
                <button (click)="replyAttachments.splice(i, 1); $event.stopPropagation()" class="remove-chip">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <button 
                class="add-more-btn"
                (click)="replyFileInput.click()"
                *ngIf="replyAttachments.length < maxFiles">
                <i class="fas fa-plus"></i> Aggiungi
              </button>
            </div>
          </div>
          
          <div class="message-input-wrapper">
            <input 
              type="text" 
              [(ngModel)]="newMessage" 
              placeholder="Scrivi un messaggio..."
              (keyup.enter)="sendMessage()"
              [disabled]="!canReplyToTicket(selectedTicket)"
              class="message-input">
            
            <button 
              class="send-btn" 
              (click)="sendMessage()"
              [disabled]="!canReplyToTicket(selectedTicket) || (!newMessage.trim() && replyAttachments.length === 0)">
              <i class="fas fa-paper-plane" *ngIf="!isUploadingReplyAttachments"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="isUploadingReplyAttachments"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== NEW TICKET MODAL (MODIFIED) ==================== -->
<div class="modal-overlay" *ngIf="showNewTicketModal" (click)="closeNewTicketModal()">
  <div class="modal-container" [class.shake]="isShaking" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-plus-circle"></i>
        <span>Nuovo Ticket</span>
      </div>
      <button class="close-btn" (click)="closeNewTicketModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form>
        <div class="form-group">
          <label>Contratto <span class="required">*</span></label>
          <mat-form-field
            appearance="fill"
            class="contract-select-field"
            [class.error]="showValidationError && !newTicket.contract_id">
            <mat-select
              [(ngModel)]="newTicket.contract_id"
              name="contractId"
              required
              placeholder="Seleziona un contratto"
              (openedChange)="onContractPanelToggle($event)"
              panelClass="contract-select-panel">
              <mat-option class="contract-search-option" disabled>
                <div class="contract-search-wrapper" (click)="$event.stopPropagation()">
                  <mat-icon>search</mat-icon>
                  <input
                    #contractSearchInput
                    type="text"
                    [value]="contractSearchQuery"
                    placeholder="Cerca contratto..."
                    (input)="onContractSearch($any($event.target).value || '')"
                    (keydown)="$event.stopPropagation()"
                    (click)="$event.stopPropagation()"
                  />
                </div>
              </mat-option>
              <mat-option *ngIf="isLoadingContractOptions" class="contract-loading-option" disabled>
                <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
                Caricamento...
              </mat-option>
              <mat-option *ngFor="let contract of filteredContracts" [value]="contract.id">
               {{contract.id}} - {{contract.codice_contratto}} - {{contract.customer_data?.nome || contract.customer_data?.ragione_sociale}} {{contract.customer_data?.cognome || ''}}
              </mat-option>
              <mat-option *ngIf="!isLoadingContractOptions && filteredContracts.length === 0" disabled>
                Nessun contratto trovato
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="form-group">
          <label>Titolo <span class="required">*</span></label>
          <input 
            type="text" 
            [(ngModel)]="newTicket.title" 
            name="title" 
            required 
            class="form-control"
            [class.error]="showValidationError && !newTicket.title"
            placeholder="Inserisci il titolo del ticket">
        </div>
        
        <div class="form-group">
          <label>Descrizione <span class="required">*</span></label>
          <textarea 
            [(ngModel)]="newTicket.description" 
            name="description" 
            required 
            class="form-control"
            [class.error]="showValidationError && !newTicket.description"
            rows="4"
            placeholder="Descrivi il problema o la richiesta..."></textarea>
        </div>
        
        <div class="form-group">
          <label>Priorità</label>
          <select [(ngModel)]="newTicket.priority" name="priority" class="form-control">
            <option *ngFor="let priority of priorities" [value]="priority.value">
              {{priority.label}}
            </option>
          </select>
        </div>

        <!-- Attachments for new ticket (MODIFIED) -->
        <div class="form-group">
          <label>
            <i class="fas fa-paperclip"></i> 
            Allegati (Opzionale)
          </label>
          <div class="attachment-upload-area">
            <input 
              type="file" 
              #newTicketFileInput
              style="display: none"
              multiple
              (change)="onNewTicketFilesSelected($event)"
              accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt,.zip">
            
            <button 
              type="button"
              class="attachment-upload-btn" 
              (click)="newTicketFileInput.click()"
              [disabled]="newTicketAttachments.length >= maxFiles">
              <i class="fas fa-cloud-upload-alt"></i>
              Aggiungi Allegati (max {{maxFiles}})
            </button>
            
            <div class="selected-files-list" *ngIf="newTicketAttachments.length > 0">
              <div *ngFor="let file of newTicketAttachments; let i = index" 
                   class="file-item clickable-attachment"
                   (click)="openPendingAttachmentPreview(file, i)"
                   [title]="'Clicca per visualizzare: ' + file.name">
                <i class="fas fa-file"></i>
                <span class="file-name">{{file.name}}</span>
                <span class="file-size">({{formatFileSize(file.size)}})</span>
                <i class="fas fa-eye preview-icon-inline"></i>
                <button 
                  type="button"
                  (click)="newTicketAttachments.splice(i, 1); $event.stopPropagation()" 
                  class="remove-file-btn">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <p class="upload-hint">
              <i class="fas fa-info-circle"></i>
              Max {{maxFiles}} file, {{formatFileSize(maxFileSize)}} ciascuno
            </p>
          </div>
        </div>

        <div class="validation-message" *ngIf="showValidationError">
          <i class="fas fa-exclamation-triangle"></i>
          Compila tutti i campi obbligatori contrassegnati con *
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeNewTicketModal()">
            Annulla
          </button>
          <button type="button" class="btn btn-primary" (click)="saveNewTicket()" [disabled]="isUploadingNewTicketAttachments">
            <i class="fas fa-save" *ngIf="!isUploadingNewTicketAttachments"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isUploadingNewTicketAttachments"></i>
            Crea Ticket
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ==================== ACCESS DENIED MESSAGE ==================== -->
<div class="access-denied" *ngIf="!canManageTickets()">
  <div class="access-denied-content">
    <i class="fas fa-lock"></i>
    <h2>Accesso Negato</h2>
    <p>Solo gli amministratori e i membri del backoffice possono accedere alla gestione ticket.</p>
  </div>
</div>