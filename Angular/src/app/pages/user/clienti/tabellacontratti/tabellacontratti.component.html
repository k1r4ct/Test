<div @pageTransition (@pageTransition.done)="animationDone($event)" class="table-contracts-container">
  <mat-spinner [hidden]="matspinner" class="loading-spinner"></mat-spinner>
  
  <div class="table-contracts-card">
    <!-- Modern Header -->
    <div class="card-header modern-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="material-icons">assignment</i>
        </div>
        <div class="header-text">
          <h1 class="card-title">Contratti Generati</h1>
          <p class="card-subtitle">Monitora i contratti generati</p>
        </div>
      </div>
      
      <!-- Hint for expandable rows -->
      <div class="expand-hint">
        <i class="material-icons">touch_app</i>
        <span>Clicca sulla singola voce di contratto per dettagli aggiuntivi</span>
      </div>
      
      <!-- Filters -->
      <div class="filters-container">
        <p-multiSelect
          [options]="LeadsContract"
          [(ngModel)]="contractSelected"
          optionLabel="id"
          display="chip"
          placeholder="Seleziona ID"
          appendTo="body"
          (onChange)="applyFilter()"
          class="modern-filter"
        />

        <p-multiSelect
          [options]="statiUnivoci"
          [(ngModel)]="statusContractSelected"
          optionLabel="nome"
          display="chip"
          placeholder="Seleziona Stato"
          appendTo="body"
          (onChange)="applyFilter()"
          class="modern-filter"
        />

        <p-multiSelect
          [options]="pivaCodFiscUnivoci"
          [(ngModel)]="pivaCodFisc"
          optionLabel="valore"
          display="chip"
          placeholder="Seleziona P.iva/Cod.Fiscale"
          appendTo="body"
          (onChange)="applyFilter()"
          class="modern-filter"
        />

        <p-multiSelect
          [options]="indirizziUnivoci"
          [(ngModel)]="indirizzoSelected"
          optionLabel="valore"
          display="chip"
          placeholder="Seleziona Indirizzo di Fornitura"
          appendTo="body"
          (onChange)="applyFilter()"
          class="modern-filter"
        />
      </div>
    </div>
    
    <!-- Table Body -->
    <div class="card-body modern-body">
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="modern-table">
          
          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef class="col-id">ID</th>
            <td mat-cell *matCellDef="let contract" class="col-id">
              <span class="id-badge">{{ contract.id }}</span>
            </td>
          </ng-container>

          <!-- Nominativo/Rag.Sociale Column -->
          <ng-container matColumnDef="nominativo/Rag.Sociale">
            <th mat-header-cell *matHeaderCellDef class="col-nominativo">NOMINATIVO/RAG.SOCIALE</th>
            <td mat-cell *matCellDef="let contract" class="col-nominativo">
              <div class="nominativo-cell">
                <i class="material-icons">person</i>
                <span>{{ contract.nomeRag_Sociale }}</span>
              </div>
            </td>
          </ng-container>

          <!-- P.IVA/Cod.Fiscale Column -->
          <ng-container matColumnDef="p.iva/cod.fisc">
            <th mat-header-cell *matHeaderCellDef class="col-piva">P.IVA/COD.FISCALE</th>
            <td mat-cell *matCellDef="let contract" class="col-piva">
              <div class="piva-cell">
                <i class="material-icons">badge</i>
                <span>{{ contract.pIva_CodFisc }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Indirizzo di Fornitura Column -->
          <ng-container matColumnDef="indirizzo_fornitura">
            <th mat-header-cell *matHeaderCellDef class="col-indirizzo">
              <div class="header-with-icon">
                <!-- <i class="material-icons">location_on</i> -->
                <span>INDIRIZZO DI FORNITURA</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let contract" class="col-indirizzo">
              <div class="indirizzo-cell">
                <i class="material-icons">place</i>
                <span class="indirizzo-text" [title]="contract.indirizzo_fornitura">
                  {{ contract.indirizzo_fornitura }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Data Inserimento Column -->
          <ng-container matColumnDef="Data Inserimento">
            <th mat-header-cell *matHeaderCellDef class="col-data">DATA INSERIMENTO</th>
            <td mat-cell *matCellDef="let contract" class="col-data">
              <div class="date-cell">
                <i class="material-icons">calendar_today</i>
                <span>{{ contract.data_Ins }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Prodotto Column -->
          <ng-container matColumnDef="Prodotto">
            <th mat-header-cell *matHeaderCellDef class="col-prodotto">PRODOTTO</th>
            <td mat-cell *matCellDef="let contract" class="col-prodotto">
              <div class="product-cell">
                <!-- <i class="material-icons">inventory_2</i> -->
                <span>{{ contract.Prodotto }}</span>
              </div>
            </td>
          </ng-container>
          
          <!-- Consumo kWh Column -->
          <ng-container matColumnDef="consumo_kwh">
            <th mat-header-cell *matHeaderCellDef class="col-consumo">
              <div class="header-with-icon">
                <i class="material-icons">bolt</i>
                <span>CONSUMO KWH</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let contract" class="col-consumo">
              <span class="data-value" [class.no-data]="!contract.consumo_kwh">
                {{ contract.consumo_kwh ? formatConsumption(contract.consumo_kwh, 'kWh') : '-' }}
              </span>
            </td>
          </ng-container>

          <!-- Consumo Gm3 Column -->
          <ng-container matColumnDef="consumo_gm3">
            <th mat-header-cell *matHeaderCellDef class="col-consumo">
              <div class="header-with-icon">
                <i class="material-icons">local_fire_department</i>
                <span>CONSUMO GM続</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let contract" class="col-consumo">
              <span class="data-value" [class.no-data]="!contract.consumo_gm3">
                {{ contract.consumo_gm3 ? formatConsumption(contract.consumo_gm3, 'Gm続') : '-' }}
              </span>
            </td>
          </ng-container>

          <!-- CTE Column -->
          <ng-container matColumnDef="cte">
            <th mat-header-cell *matHeaderCellDef class="col-cte">
              <div class="header-with-icon">
                <i class="material-icons">tag</i>
                <span>CTE</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let contract" class="col-cte">
              <span class="data-value code-value" [class.no-data]="!contract.cte">
                {{ contract.cte || '-' }}
              </span>
            </td>
          </ng-container>

          <!-- POD Column -->
          <ng-container matColumnDef="pod">
            <th mat-header-cell *matHeaderCellDef class="col-pod">
              <div class="header-with-icon">
                <i class="material-icons">confirmation_number</i>
                <span>POD/PDR</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let contract" class="col-pod">
              <span class="data-value code-value" [class.no-data]="!contract.pod">
                {{ contract.pod || '-' }}
              </span>
            </td>
          </ng-container>

          <!-- Data Attivazione Column -->
          <ng-container matColumnDef="data_attivazione">
            <th mat-header-cell *matHeaderCellDef class="col-data">
              <div class="header-with-icon">
                <i class="material-icons">event_available</i>
                <span>DATA ATTIVAZIONE</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let contract" class="col-data">
              <span class="data-value date-value" [class.no-data]="!contract.data_attivazione" [class.active-date]="contract.data_attivazione">
                {{ contract.data_attivazione ? formatDate(contract.data_attivazione) : '-' }}
              </span>
            </td>
          </ng-container>

          <!-- SEU Column -->
          <ng-container matColumnDef="Seu">
            <th mat-header-cell *matHeaderCellDef class="col-seu">SEU</th>
            <td mat-cell *matCellDef="let contract" class="col-seu">
              <div class="seu-cell">
                <!-- <i class="material-icons">support_agent</i> -->
                <span>{{ contract.seu }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Stato Column -->
          <ng-container matColumnDef="Stato">
            <th mat-header-cell *matHeaderCellDef class="col-stato">STATO</th>
            <td mat-cell *matCellDef="let contract" class="col-stato">
              <span class="status-badge" [attr.data-status]="contract.Stato">
                {{ contract.Stato }}
              </span>
            </td>
          </ng-container>

          <!-- Expanded Row for Mobile/Details -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let contract" [attr.colspan]="displayedColumns.length">
              <div class="expanded-detail" 
                   [@detailExpand]="isExpanded(contract) ? 'expanded' : 'collapsed'">
                <div class="detail-grid">
                  <!-- Indirizzo in expanded view -->
                  <div class="detail-item" *ngIf="contract.indirizzo_fornitura && contract.indirizzo_fornitura !== '-'">
                    <span class="detail-label"><i class="material-icons">location_on</i> Indirizzo di Fornitura</span>
                    <span class="detail-value">{{ contract.indirizzo_fornitura }}</span>
                  </div>
                  <div class="detail-item" *ngIf="contract.consumo_kwh">
                    <span class="detail-label"><i class="material-icons">bolt</i> Consumo kWh</span>
                    <span class="detail-value">{{ formatConsumption(contract.consumo_kwh, 'kWh') }}</span>
                  </div>
                  <div class="detail-item" *ngIf="contract.consumo_gm3">
                    <span class="detail-label"><i class="material-icons">local_fire_department</i> Consumo Gm続</span>
                    <span class="detail-value">{{ formatConsumption(contract.consumo_gm3, 'Gm続') }}</span>
                  </div>
                  <div class="detail-item" *ngIf="contract.cte">
                    <span class="detail-label"><i class="material-icons">tag</i> CTE</span>
                    <span class="detail-value code">{{ contract.cte }}</span>
                  </div>
                  <div class="detail-item" *ngIf="contract.pod">
                    <span class="detail-label"><i class="material-icons">confirmation_number</i> POD/PDR</span>
                    <span class="detail-value code">{{ contract.pod }}</span>
                  </div>
                  <div class="detail-item" *ngIf="contract.data_attivazione">
                    <span class="detail-label"><i class="material-icons">event_available</i> Attivato il</span>
                    <span class="detail-value highlight">{{ formatDate(contract.data_attivazione) }}</span>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Table Rows -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row 
              *matRowDef="let row; columns: displayedColumns;"
              class="contract-row"
              [class.expanded-row]="isExpanded(row)"
              (click)="toggleRow(row)">
          </tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

        </table>
        
        <!-- Pagination -->
        <mat-paginator 
          #paginator 
          class="modern-paginator" 
          [pageSizeOptions]="[5, 10, 20, 50]" 
          showFirstLastButtons>
        </mat-paginator>
      </div>
    </div>
  </div>
</div>